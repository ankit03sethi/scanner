<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Order Scanner</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1a1a2e">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- html5-qrcode loaded at end of body -->
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#1a1a2e;color:#eee;min-height:100vh;overflow-x:hidden}
    .header{background:linear-gradient(135deg,#16213e,#0f3460);padding:14px 20px;text-align:center}
    .header h1{font-size:18px;font-weight:600}
    .header .sub{font-size:11px;color:#8899aa;margin-top:3px}
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
    .dot.on{background:#39ff14;box-shadow:0 0 6px #39ff14}.dot.off{background:#ff073a;box-shadow:0 0 6px #ff073a}

    /* Pages */
    .page{display:none;margin:10px}
    .page.active{display:block}

    /* Settings */
    .setup{background:#16213e;padding:16px;border-radius:12px;border:1px solid #0f3460}
    .setup label{font-size:13px;color:#8899aa;display:block;margin-bottom:6px}
    .setup input{width:100%;padding:12px;border:1px solid #0f3460;border-radius:8px;background:#1a1a2e;color:#eee;font-size:14px;outline:none}
    .hint{font-size:11px;color:#667;margin-top:6px}
    .save-btn{width:100%;padding:12px;margin-top:12px;background:#39ff14;color:#1a1a2e;border:none;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer}

    /* Product Summary */
    .total-box{background:linear-gradient(135deg,#0f3460,#16213e);padding:20px;border-radius:12px;text-align:center;margin-bottom:12px}
    .total-num{font-size:42px;font-weight:700;color:#39ff14}
    .total-stats{display:flex;flex-direction:column;gap:0;margin-top:8px}
    .stat-line{font-size:17px;font-weight:700;padding:10px 16px;border-radius:8px;cursor:pointer;transition:all 0.15s}
    .stat-line:active{transform:scale(0.97);opacity:0.8}
    .stat-line.stat-ok{color:#39ff14}
    .stat-line.stat-nf{color:#e09f3e}
    .stat-line.stat-dp{color:#dc2f02}
    .stat-line.stat-total{color:#fff;border-top:1px solid #0f3460;padding-top:10px;margin-top:4px;cursor:default}
    .stat-line.stat-total:active{transform:none;opacity:1}
    .nf-tag{color:#e09f3e}
    .dp-tag{color:#dc2f02}
    .product-list{list-style:none}
    .product-item{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#16213e;border-radius:10px;margin-bottom:8px;cursor:pointer;border:1px solid #0f3460;transition:all 0.2s}
    .product-item:active{transform:scale(0.98);border-color:#39ff14}
    .product-name{font-size:22px;font-weight:600}
    .product-count{font-size:20px;font-weight:700;color:#39ff14}
    .product-nfdp{font-size:12px;font-weight:600;margin-top:2px}
    .product-arrow{color:#555;font-size:18px}
    .loading-page{text-align:center;padding:40px}
    .spinner{width:36px;height:36px;border:3px solid #333;border-top-color:#39ff14;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .settings-link{text-align:center;margin-top:16px}
    .settings-link button{background:none;border:1px solid #0f3460;color:#8899aa;padding:8px 20px;border-radius:8px;font-size:12px;cursor:pointer}

    /* Person Numbers Row on Home */
    .person-row{display:flex;gap:8px;justify-content:center;margin:16px 0 8px;flex-wrap:wrap}
    .person-row-btn{width:44px;height:44px;border-radius:10px;border:2px solid #0f3460;background:#16213e;color:#39ff14;font-size:20px;font-weight:700;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center}
    .person-row-btn:active{transform:scale(0.9);border-color:#39ff14;background:#0f3460}

    /* Company Page */
    .company-header{display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#0f3460,#16213e);padding:16px;border-radius:12px;margin-bottom:12px}
    .company-header-left{flex:1}
    .company-product-name{font-size:28px;font-weight:700;color:#fff}
    .company-product-count{font-size:16px;color:#39ff14;font-weight:600;margin-top:4px}
    .company-nfdp{font-size:13px;font-weight:600;margin-top:2px}
    .scan-all-btn{background:linear-gradient(135deg,#39ff14,#00e676);color:#1a1a2e;border:none;border-radius:10px;padding:12px 20px;font-size:15px;font-weight:700;cursor:pointer;white-space:nowrap}
    .company-item{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#16213e;border-radius:10px;margin-bottom:8px;cursor:pointer;border:1px solid #0f3460;transition:all 0.2s}
    .company-item:active{transform:scale(0.98);border-color:#39ff14}
    .company-name{font-size:20px;font-weight:600}
    .company-count{font-size:20px;font-weight:700;color:#39ff14}

    /* Scanner Page */
    .back-btn{background:none;border:none;color:#39ff14;font-size:14px;font-weight:600;cursor:pointer;padding:8px 0;margin-bottom:8px}
    .counter-box{background:#16213e;padding:12px 16px;border-radius:10px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .counter-product{font-size:16px;font-weight:600}
    .counter-nums{font-size:22px;font-weight:700;color:#39ff14}
    .counter-nfdp{font-size:12px;font-weight:600;margin-top:2px;text-align:right}
    .counter-label{font-size:11px;color:#8899aa}
    .scanner-box{margin:0 0 8px;border-radius:12px;overflow:hidden;background:#000;min-height:280px;position:relative}
    #reader{width:100%;min-height:280px}
    .controls{display:flex;gap:8px;margin:0 0 8px}
    .btn{flex:1;padding:12px;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
    .btn-go{background:linear-gradient(135deg,#39ff14,#00e676);color:#1a1a2e;font-weight:700}
    .btn-stop{background:#333;color:#ccc}
    .manual{display:flex;gap:8px;margin:0 0 8px}
    .manual input{flex:1;padding:10px;border:1px solid #0f3460;border-radius:8px;background:#1a1a2e;color:#eee;font-size:14px;outline:none}
    .manual button{padding:10px 16px;background:#0f3460;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer}
    .loading{display:none;text-align:center;padding:16px}
    .result{padding:14px;border-radius:12px;text-align:center;display:none;animation:slideUp .3s ease;margin:0 0 8px}
    @keyframes slideUp{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
    .result.ok{background:linear-gradient(135deg,#0a3d1e,#1b5e3a);border:2px solid #39ff14}
    .result.no{background:linear-gradient(135deg,#5a3e00,#7c5800);border:2px solid #e09f3e}
    .result.duplicate{background:linear-gradient(135deg,#6a040f,#9d0208);border:2px solid #dc2f02}
    .result.nf-duplicate{background:linear-gradient(135deg,#5a1a00,#7c2800);border:2px solid #ff6b35}
    .result.error{background:linear-gradient(135deg,#333,#555);border:2px solid #888}
    .r-row{display:flex;align-items:center;justify-content:center;gap:10px}
    .r-icon{font-size:24px}
    .r-status{font-size:28px;font-weight:700}
    .r-details{font-size:24px;color:#fff;margin-top:6px;font-weight:600}
    .r-code{font-size:11px;color:#aaa;margin-top:4px;font-family:monospace}
    @keyframes vib{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
    .vib{animation:vib .15s ease 3}

    /* Barcode Lists */
    .list-section{margin-top:8px}
    .list-header{font-size:13px;color:#8899aa;font-weight:600;margin-bottom:6px;padding:0 4px}
    .bc-list{max-height:250px;overflow-y:auto}
    .bc-item{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;padding:8px 10px;background:#16213e;border-radius:6px;margin-bottom:4px;font-size:12px;font-family:monospace;color:#ccc;gap:4px;overflow:visible}
    .bc-item.scanned{background:#1b4332;color:#39ff14;text-decoration:line-through;opacity:0.6}
    .bc-item.nf-item{background:#3d2e00;color:#e09f3e;border:1px solid #7c5800}
    .bc-item.dp-item{background:#3d0a0a;color:#dc2f02;border:1px solid #6a040f}
    .bc-detail{font-size:11px;color:#8899aa;font-family:-apple-system,sans-serif;max-width:45%;text-align:right;overflow:hidden;text-overflow:ellipsis}
    .pc-tag{font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:4px;display:inline-block;background:#0f3460;color:#39ff14;white-space:nowrap}
    .origin-tag{font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:4px;display:inline-block;white-space:nowrap}
    .origin-tag.tag-scanned{background:#1b4332;color:#39ff14}
    .origin-tag.tag-nf{background:#3d2e00;color:#e09f3e}

    /* Save confirmation buttons */
    .save-confirm-area{margin-top:10px;display:flex;gap:12px;justify-content:center}
    .save-confirm-btn{flex:1;max-width:160px;padding:12px 20px;border:none;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.2s;text-align:center}
    .save-confirm-btn:active{transform:scale(0.95)}
    .save-confirm-btn.save-nf{background:#e09f3e;color:#1a1a2e}
    .save-confirm-btn.save-dp{background:#dc2f02;color:#fff}
    .save-confirm-btn.save-nfdp{background:#dc2f02;color:#fff}
    .save-confirm-btn.skip-btn{background:#333;color:#aaa;border:1px solid #555}

    /* Person Picker */
    .person-picker-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(10,10,30,0.95);z-index:50;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:12px}
    .person-picker-title{font-size:18px;font-weight:700;color:#fff;margin-bottom:6px}
    .person-picker-sub{font-size:13px;color:#8899aa;margin-bottom:16px}
    .person-picker-grid{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;max-width:280px}
    .person-btn{width:60px;height:60px;border-radius:12px;border:2px solid #0f3460;background:#16213e;color:#39ff14;font-size:24px;font-weight:700;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center}
    .person-btn:active{transform:scale(0.9);border-color:#39ff14;background:#0f3460}

    /* Close Scanner Button */
    .close-scanner-btn{width:100%;padding:12px;border:none;border-radius:10px;background:#dc2f02;color:#fff;font-size:15px;font-weight:700;cursor:pointer;margin-top:8px;display:none}
    .close-scanner-btn:active{transform:scale(0.98);opacity:0.8}

    /* Person badge */
    .person-badge{display:inline-block;background:#0f3460;color:#39ff14;font-size:12px;font-weight:700;padding:3px 10px;border-radius:12px;margin-left:8px}

    /* Person Detail Pages */
    .person-summary-header{background:linear-gradient(135deg,#0f3460,#16213e);padding:20px;border-radius:12px;margin-bottom:12px;text-align:center}
    .person-summary-title{font-size:24px;font-weight:700;color:#fff;margin-bottom:12px}
    .person-summary-counts{display:flex;justify-content:center;gap:40px}
    .person-summary-col{text-align:center}
    .person-summary-col .count-num{font-size:32px;font-weight:700;color:#39ff14}
    .person-summary-col .count-label{font-size:13px;color:#8899aa;margin-top:2px}
    .details-btn{width:100%;padding:12px;background:#0f3460;color:#39ff14;border:2px solid #39ff14;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;margin-bottom:12px;transition:all 0.2s}
    .details-btn:active{transform:scale(0.98);background:#39ff14;color:#1a1a2e}

    /* Person Product Detail Table */
    .detail-table-header{display:flex;padding:10px 12px;background:#0f3460;border-radius:8px;margin-bottom:6px;font-size:12px;font-weight:700;color:#8899aa}
    .detail-table-header span{flex:1;text-align:center}
    .detail-table-header span:first-child{flex:2;text-align:left}
    .detail-row{display:flex;padding:12px;background:#16213e;border-radius:8px;margin-bottom:6px;font-size:14px;cursor:pointer;border:1px solid #0f3460;transition:all 0.2s;align-items:center}
    .detail-row:active{transform:scale(0.98);border-color:#39ff14}
    .detail-row span{flex:1;text-align:center;font-weight:600}
    .detail-row span:first-child{flex:2;text-align:left;font-size:13px}
    .detail-row .packed-num{color:#39ff14;font-size:18px}
    .detail-row .checked-num{color:#4fc3f7;font-size:18px}

    /* Mobile fixes */
    @media(max-width:480px){
      .bc-item{font-size:11px;padding:6px 8px}
      .bc-detail{font-size:10px;max-width:45%}
      .pc-tag{font-size:9px;padding:1px 4px;margin-left:2px}
      .origin-tag{font-size:9px;padding:1px 4px;margin-left:2px}
      .person-summary-counts{gap:20px}
      .person-summary-col .count-num{font-size:28px}
      .detail-row{padding:10px}
      .detail-row span:first-child{font-size:12px}
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Order Scanner</h1>
    <div class="sub"><span class="dot" id="dot"></span></div>
  </div>

  <!-- PAGE: SETTINGS -->
  <div class="page" id="page-settings">
    <div class="setup">
      <label>Google Apps Script Web App URL</label>
      <input type="url" id="apiUrl" placeholder="https://script.google.com/macros/s/..../exec">
      <div class="hint">Paste the URL from Deploy > Web App in your Google Sheet's Apps Script</div>
      <button class="save-btn" id="saveBtn">Save & Connect</button>
      <div id="debugMsg" style="margin-top:8px;font-size:12px;color:#e09f3e;display:none"></div>
    </div>
  </div>

  <!-- PAGE: PRODUCT SUMMARY (active by default since API is hardcoded) -->
  <div class="page active" id="page-products">
    <div class="loading-page" id="productsLoading"><div class="spinner"></div><div>Loading products...</div></div>
    <div id="productsContent" style="display:none">
      <div class="total-box" style="display:flex;align-items:center;justify-content:space-between">
        <div style="flex:1;text-align:center">
          <div class="total-num" id="totalCount">0</div>
          <div class="total-stats" id="totalStats">
            <div class="stat-line stat-ok" id="statOk" onclick="openStatusList('ok')">Successful - 0</div>
            <div class="stat-line stat-nf" id="statNf" style="display:none" onclick="openStatusList('nf')">Not Found - 0</div>
            <div class="stat-line stat-dp" id="statDp" style="display:none" onclick="openStatusList('dp')">Duplicates - 0</div>
            <div class="stat-line stat-total" id="statTotal">Total - 0</div>
          </div>
        </div>
        <button class="scan-all-btn" onclick="scanAllGlobal()">Scan All</button>
      </div>
      <ul class="product-list" id="productList"></ul>
      <!-- Person Numbers Row -->
      <div class="person-row" id="personRow">
        <button class="person-row-btn" onclick="openPersonSummary(1)">1</button>
        <button class="person-row-btn" onclick="openPersonSummary(2)">2</button>
        <button class="person-row-btn" onclick="openPersonSummary(3)">3</button>
        <button class="person-row-btn" onclick="openPersonSummary(4)">4</button>
        <button class="person-row-btn" onclick="openPersonSummary(5)">5</button>
        <button class="person-row-btn" onclick="openPersonSummary(6)">6</button>
        <button class="person-row-btn" onclick="openPersonSummary(7)">7</button>
      </div>
    </div>
  </div>

  <!-- PAGE: PERSON SUMMARY -->
  <div class="page" id="page-person-summary">
    <button class="back-btn" onclick="goBackToProducts()">&larr; Back to Products</button>
    <div class="loading-page" id="personSummaryLoading"><div class="spinner"></div><div>Loading person data...</div></div>
    <div id="personSummaryContent" style="display:none">
      <div class="person-summary-header">
        <div class="person-summary-title" id="personSummaryTitle">Person 1</div>
        <div class="person-summary-counts">
          <div class="person-summary-col">
            <div class="count-num" id="personPackedTotal">0</div>
            <div class="count-label">Packed</div>
          </div>
          <div class="person-summary-col">
            <div class="count-num" id="personCheckedTotal" style="color:#4fc3f7">0</div>
            <div class="count-label">Checked</div>
          </div>
        </div>
      </div>
      <button class="details-btn" onclick="openPersonProducts()">Details</button>
    </div>
  </div>

  <!-- PAGE: PERSON PRODUCTS (detail breakdown) -->
  <div class="page" id="page-person-products">
    <button class="back-btn" onclick="goBackToPersonSummary()">&larr; Back</button>
    <div class="loading-page" id="personProductsLoading"><div class="spinner"></div><div>Loading details...</div></div>
    <div id="personProductsContent" style="display:none">
      <div class="person-summary-header" style="padding:14px 20px">
        <div class="person-summary-title" id="personProductsTitle" style="font-size:20px;margin-bottom:0">Person 1 - Details</div>
      </div>
      <div class="detail-table-header">
        <span>Product</span>
        <span>Packed</span>
        <span>Checked</span>
      </div>
      <div id="personProductsList"></div>
    </div>
  </div>

  <!-- PAGE: PERSON COMPANIES (drill-down from product) -->
  <div class="page" id="page-person-companies">
    <button class="back-btn" onclick="goBackToPersonProducts()">&larr; Back</button>
    <div class="loading-page" id="personCompaniesLoading"><div class="spinner"></div><div>Loading companies...</div></div>
    <div id="personCompaniesContent" style="display:none">
      <div class="person-summary-header" style="padding:14px 20px">
        <div class="person-summary-title" id="personCompaniesTitle" style="font-size:20px;margin-bottom:0">Product - Companies</div>
      </div>
      <div class="detail-table-header">
        <span>Company</span>
        <span>Packed</span>
        <span>Checked</span>
      </div>
      <div id="personCompaniesList"></div>
      <!-- Scanned items list (OK status) -->
      <div id="personScannedSection" style="display:none;margin-top:16px">
        <div class="list-header" style="color:#39ff14;font-size:14px;margin-bottom:8px" id="personScannedHeader">Scanned (0)</div>
        <div class="bc-list" id="personScannedList" style="max-height:none"></div>
      </div>
      <!-- Duplicates list (DUPLICATE/NF_DUPLICATE status) -->
      <div id="personDupSection" style="display:none;margin-top:16px">
        <div class="list-header" style="color:#dc2f02;font-size:14px;margin-bottom:8px" id="personDupHeader">Duplicates (0)</div>
        <div class="bc-list" id="personDupList" style="max-height:none"></div>
      </div>
    </div>
  </div>

  <!-- PAGE: COMPANY LIST -->
  <div class="page" id="page-companies">
    <button class="back-btn" onclick="goBackToProducts()">&larr; Back to Products</button>
    <div class="loading-page" id="companiesLoading"><div class="spinner"></div><div>Loading companies...</div></div>
    <div id="companiesContent" style="display:none">
      <div class="company-header">
        <div class="company-header-left">
          <div class="company-product-name" id="companyProductName">-</div>
          <div class="company-product-count" id="companyProductCount">0 / 0</div>
          <div class="company-nfdp" id="companyNFDP"></div>
        </div>
        <button class="scan-all-btn" onclick="selectCompany('')">Scan All</button>
      </div>
      <ul class="product-list" id="companyList"></ul>
    </div>
  </div>

  <!-- PAGE: STATUS LIST (all items by status) -->
  <div class="page" id="page-status-list">
    <button class="back-btn" onclick="goBackToProducts()">&larr; Back to Products</button>
    <div class="loading-page" id="statusListLoading"><div class="spinner"></div><div>Loading...</div></div>
    <div id="statusListContent" style="display:none">
      <div class="person-summary-header" style="padding:14px 20px">
        <div class="person-summary-title" id="statusListTitle" style="font-size:20px;margin-bottom:0">All Successful</div>
      </div>
      <div class="bc-list" id="statusListItems" style="max-height:none"></div>
    </div>
  </div>

  <!-- PAGE: SCANNER -->
  <div class="page" id="page-scanner">
    <button class="back-btn" id="scannerBackBtn" onclick="goBack()">&larr; Back</button>

    <!-- Result on top -->
    <div class="loading" id="loading"><div class="spinner"></div><div>Checking...</div></div>
    <div class="result" id="resultCard">
      <div class="r-row">
        <div class="r-icon" id="rIcon"></div>
        <div class="r-status" id="rStatus"></div>
      </div>
      <div class="r-details" id="rDetails"></div>
      <div class="r-code" id="rCode"></div>
      <div class="save-confirm-area" id="saveConfirmArea" style="display:none">
        <button class="save-confirm-btn" id="saveConfirmBtn" onclick="confirmSave()">Save</button>
        <button class="save-confirm-btn skip-btn" onclick="skipSave()">Skip</button>
      </div>
    </div>

    <!-- Counter -->
    <div class="counter-box">
      <div>
        <div class="counter-product" id="counterProduct">-</div>
        <div class="counter-label">Selected Product</div>
      </div>
      <div style="text-align:right">
        <div class="counter-nums"><span id="counterRemaining">0</span> / <span id="counterTotal">0</span></div>
        <div class="counter-nfdp" id="counterNFDP"></div>
        <div class="counter-label">Scanned</div>
      </div>
    </div>

    <!-- Scanner -->
    <div class="scanner-box" id="scannerBox">
      <div id="reader"></div>
      <div id="tapOverlay" style="display:none;position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10;cursor:pointer;align-items:center;justify-content:center">
        <div style="color:#fff;font-size:18px;font-weight:700;text-align:center;padding:20px">TAP HERE<br><span style="font-size:13px;font-weight:400;color:#aaa">to scan next barcode</span></div>
      </div>
      <!-- Packer Picker Overlay -->
      <div class="person-picker-overlay" id="packerPicker">
        <div class="person-picker-title">Select Packer</div>
        <div class="person-picker-sub">Who is packing?</div>
        <div class="person-picker-grid">
          <button class="person-btn" onclick="selectPacker(1)">1</button>
          <button class="person-btn" onclick="selectPacker(2)">2</button>
          <button class="person-btn" onclick="selectPacker(3)">3</button>
          <button class="person-btn" onclick="selectPacker(4)">4</button>
          <button class="person-btn" onclick="selectPacker(5)">5</button>
          <button class="person-btn" onclick="selectPacker(6)">6</button>
          <button class="person-btn" onclick="selectPacker(7)">7</button>
        </div>
      </div>
      <!-- Checker Picker Overlay -->
      <div class="person-picker-overlay" id="checkerPicker" style="display:none">
        <div class="person-picker-title">Select Checker</div>
        <div class="person-picker-sub">Who is checking?</div>
        <div class="person-picker-grid">
          <button class="person-btn" onclick="selectChecker(1)">1</button>
          <button class="person-btn" onclick="selectChecker(2)">2</button>
          <button class="person-btn" onclick="selectChecker(3)">3</button>
          <button class="person-btn" onclick="selectChecker(4)">4</button>
          <button class="person-btn" onclick="selectChecker(5)">5</button>
          <button class="person-btn" onclick="selectChecker(6)">6</button>
          <button class="person-btn" onclick="selectChecker(7)">7</button>
        </div>
      </div>
    </div>
    <div class="controls">
      <button class="btn btn-go" id="startBtn" onclick="startScan()" style="display:none">Start Scanning</button>
      <button class="btn btn-stop" id="stopBtn" onclick="stopScan()" style="display:none">Stop</button>
    </div>
    <button class="close-scanner-btn" id="closeScannerBtn" onclick="closeScanner()">Close Scanner</button>
    <div class="manual">
      <input type="text" id="manualCode" placeholder="Or type barcode manually...">
      <button onclick="doManual()">Check</button>
    </div>

    <!-- Remaining barcodes list -->
    <div class="list-section">
      <div class="list-header" id="remainingHeader">Remaining Barcodes (0)</div>
      <div class="bc-list" id="remainingList"></div>
    </div>

    <!-- Scanned items list -->
    <div class="list-section" style="margin-top:12px">
      <div class="list-header" id="scannedHeader" style="color:#39ff14">Scanned (0)</div>
      <div class="bc-list" id="scannedList"></div>
    </div>

    <!-- Not Found list -->
    <div class="list-section" style="margin-top:12px">
      <div class="list-header" id="nfHeader" style="color:#e09f3e">Not Found (0)</div>
      <div class="bc-list" id="nfList"></div>
    </div>

    <!-- Duplicate list -->
    <div class="list-section" style="margin-top:12px">
      <div class="list-header" id="dpHeader" style="color:#dc2f02">Duplicates (0)</div>
      <div class="bc-list" id="dpList"></div>
    </div>
  </div>

<script>
try{
document.getElementById('dot').className='dot off';
}catch(e){}

var scanner=null,isScanning=false,lastBarcode='',isChecking=false,isPaused=false;
var pendingSave=null;
var currentPerson='';
var currentChecker='';
var CURRENT_API='https://script.google.com/macros/s/AKfycbykUo_b86ptTWFjiHX0Up9NApfwVBHpum4NKhQu5HKE91VbLNUgpxVj9GMoFUwhxI5t/exec';
var apiUrl=CURRENT_API;
try{
  var storedUrl=localStorage.getItem('apiUrl')||'';
  if(storedUrl && storedUrl!==CURRENT_API){localStorage.setItem('apiUrl',CURRENT_API)}
}catch(e){}

// CRITICAL: Call initApp() HERE before any addEventListener calls
// Function declarations are hoisted so initApp/showPage/loadProducts are available
try{initApp()}catch(e){console.error('Early initApp error:',e)}

var selectedProduct='';
var selectedCompany='';
var remainingBarcodes=[];
var scannedItems=[];
var nfItems=[];
var dpItems=[];
var totalForProduct=0;

// Person detail page state
var viewingPerson='';
var viewingPersonProduct='';
function initApp(){
  try{
    if(apiUrl){
      document.getElementById('apiUrl').value=apiUrl;
      setStatus(true);
      showPage('products');
      loadProducts();
    } else {
      setStatus(false);
      showPage('settings');
    }
  }catch(err){
    console.error('Init error:',err);
    showPage('settings');
  }
}

// HELPER: Build Not Found / Duplicates tag string
function nfdpTag(nf,dp){
  if(!nf&&!dp) return '';
  var parts=[];
  if(nf) parts.push('<div class="nf-tag">Not Found - '+nf+'</div>');
  if(dp) parts.push('<div class="dp-tag">Duplicates - '+dp+'</div>');
  return parts.join('');
}

// HELPER: Build P/C tag for barcode lists
function pcTag(packer,checker){
  if(!packer&&!checker) return '';
  var parts=[];
  if(packer) parts.push('P'+packer);
  if(checker) parts.push('C'+checker);
  var txt=parts.join(' | ');
  return '<span class="pc-tag">'+txt+'</span>';
}

// PAGES
function showPage(name){
  var pages=document.querySelectorAll('.page');
  for(var i=0;i<pages.length;i++) pages[i].className='page';
  document.getElementById('page-'+name).className='page active';
}

function saveUrl(){
  var dbg=document.getElementById('debugMsg');
  try{
    dbg.style.display='block';
    dbg.textContent='Saving...';
    var u=document.getElementById('apiUrl').value.trim();
    dbg.textContent='URL: '+u.substring(0,50)+'...';
    if(!u){dbg.textContent='Error: URL is empty';return}
    if(!u.startsWith('https://script.google.com/')){dbg.textContent='Error: URL must start with https://script.google.com/';return}
    apiUrl=u;
    try{localStorage.setItem('apiUrl',u)}catch(e){}
    setStatus(true);
    dbg.textContent='Saved! Loading products...';
    showPage('products');
    loadProducts();
  }catch(err){
    dbg.style.display='block';
    dbg.textContent='Error: '+err.message;
  }
}

function setStatus(ok){
  document.getElementById('dot').className='dot '+(ok?'on':'off');
}

// LOAD PRODUCTS
function loadProducts(){
  document.getElementById('productsLoading').style.display='block';
  document.getElementById('productsContent').style.display='none';

  fetch(apiUrl+'?action=summary',{redirect:'follow'})
    .then(function(r){return r.json()})
    .then(function(data){
      document.getElementById('productsLoading').style.display='none';
      document.getElementById('productsContent').style.display='block';
      var t=data.total||0;
      var ts=data.totalScanned||0;
      var tnf=data.totalNF||0;
      var tdp=data.totalDP||0;
      document.getElementById('totalCount').textContent=ts+'/'+t;
      document.getElementById('statOk').textContent='Successful - '+ts;
      document.getElementById('statNf').textContent='Not Found - '+tnf;
      document.getElementById('statNf').style.display=tnf?'block':'none';
      document.getElementById('statDp').textContent='Duplicates - '+tdp;
      document.getElementById('statDp').style.display=tdp?'block':'none';
      document.getElementById('statTotal').textContent='Total - '+(ts+tnf+tdp);

      var list=document.getElementById('productList');
      list.innerHTML='';
      if(data.products){
        data.products.forEach(function(p){
          var li=document.createElement('li');
          li.className='product-item';
          li.innerHTML='<div><div class="product-name">'+p.name+'</div></div><div style="text-align:right"><div style="font-size:22px;color:#39ff14;font-weight:700">'+(p.scanned||0)+'/'+p.count+'</div><div class="product-nfdp">'+nfdpTag(p.nf||0,p.dp||0)+'</div></div>';
          li.onclick=function(){openCompanyPage(p.name,p.scanned||0,p.count)};
          list.appendChild(li);
        });
      }
    })
    .catch(function(e){
      document.getElementById('productsLoading').style.display='none';
      alert('Error loading products. Check API URL.');
    });
}

// OPEN COMPANY PAGE
function openCompanyPage(product,scanned,total){
  selectedProduct=product;
  showPage('companies');
  document.getElementById('companyProductName').textContent=product;
  document.getElementById('companyProductCount').textContent=scanned+'/'+total;
  document.getElementById('companyNFDP').innerHTML='';
  loadCompanies(product);
}

function loadCompanies(product){
  document.getElementById('companiesLoading').style.display='block';
  document.getElementById('companiesContent').style.display='none';

  fetch(apiUrl+'?action=companies&product='+encodeURIComponent(product),{redirect:'follow'})
    .then(function(r){return r.json()})
    .then(function(data){
      document.getElementById('companiesLoading').style.display='none';
      document.getElementById('companiesContent').style.display='block';

      var totalNF=0,totalDP=0,totalScanned=0,totalCount=0;
      if(data.companies){
        data.companies.forEach(function(c){
          totalNF+=(c.nf||0);
          totalDP+=(c.dp||0);
          totalScanned+=(c.scanned||0);
          totalCount+=c.count;
        });
      }
      document.getElementById('companyProductCount').textContent=totalScanned+'/'+totalCount;
      document.getElementById('companyNFDP').innerHTML=nfdpTag(totalNF,totalDP);

      var list=document.getElementById('companyList');
      list.innerHTML='';
      if(data.companies){
        data.companies.forEach(function(c){
          var li=document.createElement('li');
          li.className='company-item';
          li.innerHTML='<div><div class="company-name">'+c.name+'</div></div><div style="text-align:right"><div class="company-count">'+(c.scanned||0)+'/'+c.count+'</div><div class="product-nfdp">'+nfdpTag(c.nf||0,c.dp||0)+'</div></div>';
          li.onclick=function(){selectCompany(c.name)};
          list.appendChild(li);
        });
      }
    })
    .catch(function(e){
      document.getElementById('companiesLoading').style.display='none';
      alert('Error loading companies.');
    });
}

function goBackToProducts(){
  showPage('products');
  loadProducts();
}

// ==========================================
// PERSON DETAIL PAGES
// ==========================================

function openPersonSummary(num){
  viewingPerson=String(num);
  showPage('person-summary');
  document.getElementById('personSummaryTitle').textContent='Person '+viewingPerson;
  document.getElementById('personSummaryLoading').style.display='block';
  document.getElementById('personSummaryContent').style.display='none';

  fetch(apiUrl+'?action=personsummary&person='+encodeURIComponent(viewingPerson),{redirect:'follow'})
    .then(function(r){return r.json()})
    .then(function(data){
      document.getElementById('personSummaryLoading').style.display='none';
      document.getElementById('personSummaryContent').style.display='block';
      document.getElementById('personPackedTotal').textContent=data.packed||0;
      document.getElementById('personCheckedTotal').textContent=data.checked||0;
    })
    .catch(function(e){
      document.getElementById('personSummaryLoading').innerHTML='<div style="color:#e09f3e;padding:20px;text-align:center">Error loading person data: '+e.message+'</div>';
    });
}

function openPersonProducts(){
  showPage('person-products');
  document.getElementById('personProductsTitle').textContent='Person '+viewingPerson+' - Details';
  document.getElementById('personProductsLoading').style.display='block';
  document.getElementById('personProductsContent').style.display='none';

  fetch(apiUrl+'?action=personproducts&person='+encodeURIComponent(viewingPerson),{redirect:'follow'})
    .then(function(r){return r.json()})
    .then(function(data){
      document.getElementById('personProductsLoading').style.display='none';
      document.getElementById('personProductsContent').style.display='block';

      var list=document.getElementById('personProductsList');
      list.innerHTML='';
      if(data.products){
        data.products.forEach(function(p){
          var row=document.createElement('div');
          row.className='detail-row';
          row.innerHTML='<span>'+p.name+'</span><span class="packed-num">'+p.packed+'</span><span class="checked-num">'+p.checked+'</span>';
          row.onclick=function(){openPersonCompanies(p.name)};
          list.appendChild(row);
        });
      }
      if(!data.products||!data.products.length){
        list.innerHTML='<div style="text-align:center;padding:20px;color:#555">No data for this person</div>';
      }
    })
    .catch(function(e){
      document.getElementById('personProductsLoading').style.display='none';
      alert('Error loading person products.');
    });
}

function openPersonCompanies(product){
  viewingPersonProduct=product;
  showPage('person-companies');
  document.getElementById('personCompaniesTitle').textContent=product+' - Companies';
  document.getElementById('personCompaniesLoading').style.display='block';
  document.getElementById('personCompaniesContent').style.display='none';

  fetch(apiUrl+'?action=personcompanies&person='+encodeURIComponent(viewingPerson)+'&product='+encodeURIComponent(product),{redirect:'follow'})
    .then(function(r){return r.json()})
    .then(function(data){
      document.getElementById('personCompaniesLoading').style.display='none';
      document.getElementById('personCompaniesContent').style.display='block';

      var list=document.getElementById('personCompaniesList');
      list.innerHTML='';
      if(data.companies){
        data.companies.forEach(function(c){
          var row=document.createElement('div');
          row.className='detail-row';
          row.style.cursor='default';
          row.innerHTML='<span>'+c.name+'</span><span class="packed-num">'+c.packed+'</span><span class="checked-num">'+c.checked+'</span>';
          list.appendChild(row);
        });
      }
      if(!data.companies||!data.companies.length){
        list.innerHTML='<div style="text-align:center;padding:20px;color:#555">No company data</div>';
      }

      // Merge packed + checked items, group by status
      var allPersonItems={};
      var packed=data.packedItems||[];
      var checked=data.checkedItems||[];
      packed.forEach(function(b){
        var key=b.barcode+'_'+b.status;
        allPersonItems[key]={barcode:b.barcode,status:b.status,company:b.company,packer:viewingPerson,checker:b.checker||''};
      });
      checked.forEach(function(b){
        var key=b.barcode+'_'+b.status;
        if(allPersonItems[key]){
          allPersonItems[key].checker=viewingPerson;
        } else {
          allPersonItems[key]={barcode:b.barcode,status:b.status,company:b.company,packer:b.packer||'',checker:viewingPerson};
        }
      });
      var scannedArr=[];
      var dupArr=[];
      for(var key in allPersonItems){
        var item=allPersonItems[key];
        if(item.status==='OK') scannedArr.push(item);
        else dupArr.push(item);
      }

      // Render Scanned section (green)
      var scannedSec=document.getElementById('personScannedSection');
      if(scannedArr.length){
        scannedSec.style.display='block';
        document.getElementById('personScannedHeader').textContent='Scanned ('+scannedArr.length+')';
        document.getElementById('personScannedList').innerHTML=scannedArr.map(function(b){
          return '<div class="bc-item scanned" style="opacity:1;text-decoration:none"><span>'+b.barcode+pcTag(b.packer,b.checker)+'</span><span class="bc-detail">'+b.company+'</span></div>';
        }).join('');
      } else {
        scannedSec.style.display='none';
      }

      // Render Duplicates section (red)
      var dupSec=document.getElementById('personDupSection');
      if(dupArr.length){
        dupSec.style.display='block';
        document.getElementById('personDupHeader').textContent='Duplicates ('+dupArr.length+')';
        document.getElementById('personDupList').innerHTML=dupArr.map(function(b){
          return '<div class="bc-item dp-item"><span>'+b.barcode+pcTag(b.packer,b.checker)+'</span><span class="bc-detail">'+b.company+'</span></div>';
        }).join('');
      } else {
        dupSec.style.display='none';
      }
    })
    .catch(function(e){
      document.getElementById('personCompaniesLoading').style.display='none';
      alert('Error loading person companies.');
    });
}

function goBackToPersonSummary(){
  showPage('person-summary');
}

function goBackToPersonProducts(){
  showPage('person-products');
}

// ==========================================
// STATUS LIST PAGE (clickable stats on home)
// ==========================================

function openStatusList(type){
  showPage('status-list');
  var titles={ok:'All Successful',nf:'All Not Found',dp:'All Duplicates'};
  document.getElementById('statusListTitle').textContent=titles[type]||'Items';
  document.getElementById('statusListTitle').style.color=type==='ok'?'#39ff14':(type==='nf'?'#e09f3e':'#dc2f02');
  document.getElementById('statusListLoading').style.display='block';
  document.getElementById('statusListContent').style.display='none';

  fetch(apiUrl+'?action=productdata&product=&company=',{redirect:'follow'})
    .then(function(r){return r.json()})
    .then(function(data){
      document.getElementById('statusListLoading').style.display='none';
      document.getElementById('statusListContent').style.display='block';
      var items=[];
      if(type==='ok') items=data.scannedItems||[];
      else if(type==='nf') items=data.nfItems||[];
      else if(type==='dp') items=data.dpItems||[];

      var el=document.getElementById('statusListItems');
      if(!items.length){
        el.innerHTML='<div style="text-align:center;padding:20px;color:#555">No items</div>';
        return;
      }

      if(type==='ok'){
        el.innerHTML=items.map(function(b){
          return '<div class="bc-item scanned" style="opacity:1;text-decoration:none"><span>'+b.barcode+pcTag(b.packer,b.checker)+'</span><span class="bc-detail">'+b.details+'</span></div>';
        }).join('');
      } else if(type==='nf'){
        el.innerHTML=items.map(function(b){
          return '<div class="bc-item nf-item"><span>'+b.barcode+pcTag(b.packer,b.checker)+'</span><span class="bc-detail">'+b.details+'</span></div>';
        }).join('');
      } else if(type==='dp'){
        el.innerHTML=items.map(function(b){
          var originClass=b.origin==='Scanned'?'tag-scanned':'tag-nf';
          var originLabel=b.origin==='Scanned'?'Scanned':'NF';
          return '<div class="bc-item dp-item"><span>'+b.barcode+pcTag(b.packer,b.checker)+'<span class="origin-tag '+originClass+'">'+originLabel+'</span></span><span class="bc-detail">'+b.details+'</span></div>';
        }).join('');
      }
    })
    .catch(function(e){
      document.getElementById('statusListLoading').style.display='none';
      document.getElementById('statusListContent').style.display='block';
      document.getElementById('statusListItems').innerHTML='<div style="text-align:center;padding:20px;color:#e09f3e">Error loading data</div>';
    });
}

// ==========================================
// SCANNER FLOW
// ==========================================

// SCAN ALL from home page
function scanAllGlobal(){
  selectedProduct='';
  selectedCompany='';
  currentPerson='';
  currentChecker='';
  showPage('scanner');
  document.getElementById('counterProduct').textContent='All Products';
  document.getElementById('packerPicker').style.display='flex';
  document.getElementById('checkerPicker').style.display='none';
  document.getElementById('startBtn').style.display='none';
  document.getElementById('stopBtn').style.display='none';
  document.getElementById('closeScannerBtn').style.display='none';
  document.getElementById('scannerBackBtn').onclick=function(){
    if(scanner&&isScanning){
      scanner.stop().then(function(){
        isScanning=false;
        document.getElementById('startBtn').style.display='none';
        document.getElementById('stopBtn').style.display='none';
        document.getElementById('closeScannerBtn').style.display='none';
        document.getElementById('reader').innerHTML='';
      });
    }
    document.getElementById('resultCard').style.display='none';
    document.getElementById('tapOverlay').style.display='none';
    isPaused=false;
    currentPerson='';
    currentChecker='';
    showPage('products');
    loadProducts();
  };
  loadProductData('','');
}

// SELECT COMPANY (or all)
function selectCompany(company){
  selectedCompany=company;
  currentPerson='';
  currentChecker='';
  showPage('scanner');
  var label=selectedProduct+(company?' > '+company:'');
  document.getElementById('counterProduct').textContent=label;
  document.getElementById('packerPicker').style.display='flex';
  document.getElementById('checkerPicker').style.display='none';
  document.getElementById('startBtn').style.display='none';
  document.getElementById('stopBtn').style.display='none';
  document.getElementById('closeScannerBtn').style.display='none';
  document.getElementById('scannerBackBtn').onclick=function(){goBackToCompanies()};
  loadProductData(selectedProduct,company);
}

function goBackToCompanies(){
  if(scanner&&isScanning){
    scanner.stop().then(function(){
      isScanning=false;
      document.getElementById('startBtn').style.display='none';
      document.getElementById('stopBtn').style.display='none';
      document.getElementById('closeScannerBtn').style.display='none';
      document.getElementById('reader').innerHTML='';
    });
  }
  document.getElementById('resultCard').style.display='none';
  document.getElementById('tapOverlay').style.display='none';
  isPaused=false;
  currentPerson='';
  currentChecker='';
  openCompanyPage(selectedProduct,0,0);
  loadCompanies(selectedProduct);
}

function loadProductData(product,company){
  document.getElementById('remainingList').innerHTML='<div style="text-align:center;padding:16px;color:#555">Loading...</div>';
  document.getElementById('scannedList').innerHTML='';
  document.getElementById('nfList').innerHTML='';
  document.getElementById('dpList').innerHTML='';

  var url=apiUrl+'?action=productdata&product='+encodeURIComponent(product);
  if(company) url+='&company='+encodeURIComponent(company);

  fetch(url,{redirect:'follow'})
    .then(function(r){return r.json()})
    .then(function(data){
      totalForProduct=data.total||0;
      remainingBarcodes=data.barcodes||[];
      scannedItems=data.scannedItems||[];
      // Client-side safety: hide NF when in product/company view
      nfItems=(product||company)?[]:(data.nfItems||[]);
      dpItems=data.dpItems||[];
      updateCounter();
      renderBarcodeList();
      renderScannedList();
      renderNFList();
      renderDPList();
    })
    .catch(function(e){
      document.getElementById('remainingList').innerHTML='<div style="text-align:center;padding:16px;color:#e09f3e">Error loading data</div>';
    });
}

function updateCounter(){
  document.getElementById('counterRemaining').textContent=scannedItems.length;
  document.getElementById('counterTotal').textContent=totalForProduct;
  var nfdpHtml='';
  if(nfItems.length) nfdpHtml+='<div style="color:#e09f3e">Not Found - '+nfItems.length+'</div>';
  if(dpItems.length) nfdpHtml+='<div style="color:#dc2f02">Duplicates - '+dpItems.length+'</div>';
  document.getElementById('counterNFDP').innerHTML=nfdpHtml;
}

function renderBarcodeList(){
  document.getElementById('remainingHeader').textContent='Remaining Barcodes ('+remainingBarcodes.length+')';
  var el=document.getElementById('remainingList');
  if(!remainingBarcodes.length){el.innerHTML='<div style="text-align:center;padding:16px;color:#39ff14;font-weight:600">All done! No barcodes remaining.</div>';return}
  el.innerHTML=remainingBarcodes.map(function(b){
    return '<div class="bc-item"><span>'+b.barcode+'</span><span class="bc-detail">'+b.details+'</span></div>';
  }).join('');
}

function renderScannedList(){
  document.getElementById('scannedHeader').textContent='Scanned ('+scannedItems.length+')';
  var el=document.getElementById('scannedList');
  if(!scannedItems.length){el.innerHTML='<div style="text-align:center;padding:12px;color:#555">No scans yet</div>';return}
  el.innerHTML=scannedItems.map(function(b){
    return '<div class="bc-item scanned"><span>'+b.barcode+pcTag(b.packer,b.checker)+'</span><span class="bc-detail">'+b.details+'</span></div>';
  }).join('');
}

function renderNFList(){
  document.getElementById('nfHeader').textContent='Not Found ('+nfItems.length+')';
  var el=document.getElementById('nfList');
  if(!nfItems.length){el.innerHTML='';return}
  el.innerHTML=nfItems.map(function(b){
    return '<div class="bc-item nf-item"><span>'+b.barcode+pcTag(b.packer,b.checker)+'</span><span class="bc-detail">'+b.details+'</span></div>';
  }).join('');
}

function renderDPList(){
  document.getElementById('dpHeader').textContent='Duplicates ('+dpItems.length+')';
  var el=document.getElementById('dpList');
  if(!dpItems.length){el.innerHTML='';return}
  el.innerHTML=dpItems.map(function(b){
    var originClass=b.origin==='Scanned'?'tag-scanned':'tag-nf';
    var originLabel=b.origin==='Scanned'?'Scanned':'Not Found';
    return '<div class="bc-item dp-item"><span>'+b.barcode+pcTag(b.packer,b.checker)+'<span class="origin-tag '+originClass+'">'+originLabel+'</span></span><span class="bc-detail">'+b.details+'</span></div>';
  }).join('');
}

// GO BACK (legacy fallback)
function goBack(){
  goBackToCompanies();
}

// AUDIO
var AC=window.AudioContext||window.webkitAudioContext;
var ac=null;
function beep(t){
  try{
    if(!ac)ac=new AC();
    var o=ac.createOscillator(),g=ac.createGain();
    o.connect(g);g.connect(ac.destination);g.gain.value=0.5;
    if(t==='ok'){o.frequency.value=800;o.type='sine'}
    else if(t==='no'){o.frequency.value=300;o.type='square'}
    else{o.frequency.value=500;o.type='triangle'}
    o.start();
    setTimeout(function(){g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+0.3);setTimeout(function(){o.stop()},300)},150);
  }catch(e){}
}
function speak(text){try{var u=new SpeechSynthesisUtterance(text);u.volume=1;u.rate=1;u.pitch=1;u.lang='en-US';window.speechSynthesis.speak(u)}catch(e){}}

// SCANNER
function startScan(){
  if(!apiUrl){alert('Set API URL in Settings first');return}
  scanner=new Html5Qrcode("reader");
  scanner.start(
    {facingMode:"environment"},
    {fps:30,qrbox:{width:350,height:220},disableFlip:false,experimentalFeatures:{useBarCodeDetectorIfSupported:true},
      formatsToSupport:[
        Html5QrcodeSupportedFormats.QR_CODE,
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.CODE_39,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.UPC_E,
        Html5QrcodeSupportedFormats.ITF,
        Html5QrcodeSupportedFormats.CODE_93
      ]
    },
    onOk,
    function(){}
  ).then(function(){
    isScanning=true;
    document.getElementById('startBtn').style.display='none';
    document.getElementById('stopBtn').style.display='flex';
    document.getElementById('closeScannerBtn').style.display='block';
  }).catch(function(err){alert('Camera error: '+err)});
}

function stopScan(){
  if(scanner&&isScanning){
    scanner.stop().then(function(){
      isScanning=false;
      document.getElementById('startBtn').style.display='flex';
      document.getElementById('stopBtn').style.display='none';
      document.getElementById('closeScannerBtn').style.display='block';
      document.getElementById('reader').innerHTML='';
    });
  }
}

// TWO-STEP PICKER: Packer first, then Checker
function selectPacker(num){
  currentPerson=String(num);
  document.getElementById('packerPicker').style.display='none';
  document.getElementById('checkerPicker').style.display='flex';
}

function selectChecker(num){
  currentChecker=String(num);
  document.getElementById('checkerPicker').style.display='none';
  document.getElementById('counterProduct').innerHTML=document.getElementById('counterProduct').textContent+'<span class="person-badge">P'+currentPerson+' | C'+currentChecker+'</span>';
  startScan();
}

// Stop picker clicks from bubbling to scannerBox
try{document.getElementById('packerPicker').addEventListener('click',function(e){e.stopPropagation()})}catch(e){}
try{document.getElementById('checkerPicker').addEventListener('click',function(e){e.stopPropagation()})}catch(e){}

function closeScanner(){
  if(scanner&&isScanning){
    scanner.stop().then(function(){
      isScanning=false;
      document.getElementById('reader').innerHTML='';
      resetScannerUI();
    }).catch(function(){resetScannerUI()});
  } else {
    resetScannerUI();
  }
}

function resetScannerUI(){
  isScanning=false;
  isPaused=false;
  currentPerson='';
  currentChecker='';
  pendingSave=null;
  document.getElementById('startBtn').style.display='none';
  document.getElementById('stopBtn').style.display='none';
  document.getElementById('closeScannerBtn').style.display='none';
  document.getElementById('resultCard').style.display='none';
  document.getElementById('tapOverlay').style.display='none';
  document.getElementById('saveConfirmArea').style.display='none';
  document.getElementById('packerPicker').style.display='flex';
  document.getElementById('checkerPicker').style.display='none';
  var label=selectedProduct+(selectedCompany?' > '+selectedCompany:'');
  if(!selectedProduct) label='All Products';
  document.getElementById('counterProduct').textContent=label;
}

function onOk(text){
  if(isPaused||isChecking) return;
  isChecking=true;
  isPaused=true;
  lastBarcode=text;
  if(navigator.vibrate) navigator.vibrate(100);
  scanner.pause(true);
  checkCode(text);
}

function doManual(){
  var v=document.getElementById('manualCode').value.trim();
  if(!v) return;
  document.getElementById('manualCode').value='';
  isChecking=true;
  checkCode(v);
}

document.getElementById('manualCode').addEventListener('keydown',function(e){
  if(e.key==='Enter') doManual();
});

// API CALL  now sends both person (packer) and checker
function checkCode(barcode){
  if(!apiUrl){alert('Set API URL first');isChecking=false;return}
  document.getElementById('loading').style.display='block';
  document.getElementById('resultCard').style.display='none';

  var url=apiUrl+'?barcode='+encodeURIComponent(barcode);
  if(selectedProduct) url+='&product='+encodeURIComponent(selectedProduct);
  if(selectedCompany) url+='&company='+encodeURIComponent(selectedCompany);
  if(currentPerson) url+='&person='+encodeURIComponent(currentPerson);
  if(currentChecker) url+='&checker='+encodeURIComponent(currentChecker);

  fetch(url,{redirect:'follow'})
    .then(function(r){return r.json()})
    .then(function(data){
      document.getElementById('loading').style.display='none';
      showResult(data);
      isChecking=false;

      if(data.status==='OK'){
        // Only show tap overlay for OK results (no save/skip needed)
        document.getElementById('tapOverlay').style.display='flex';
        for(var i=0;i<remainingBarcodes.length;i++){
          if(remainingBarcodes[i].barcode===barcode){
            remainingBarcodes.splice(i,1);
            break;
          }
        }
        for(var i=0;i<nfItems.length;i++){
          if(nfItems[i].barcode===barcode){
            nfItems.splice(i,1);
            break;
          }
        }
        for(var i=0;i<dpItems.length;i++){
          if(dpItems[i].barcode===barcode && dpItems[i].origin==='NF'){
            dpItems[i].origin='Scanned';
          }
        }
        scannedItems.unshift({barcode:barcode,details:data.details||'',packer:currentPerson,checker:currentChecker});
        updateCounter();
        renderBarcodeList();
        renderScannedList();
        renderNFList();
        renderDPList();
      }
      if(data.status==='NO'){
        pendingSave={barcode:barcode,saveStatus:'NF',details:data.message||'Not found in reference',origin:null};
        showSaveButton('save-nf','Save');
      }
      if(data.status==='DUPLICATE'){
        pendingSave={barcode:barcode,saveStatus:'DUPLICATE',details:data.details||data.message||'Duplicate scan',origin:data.origin||'Scanned'};
        showSaveButton('save-dp','Save');
      }
      if(data.status==='NF_DUPLICATE'){
        pendingSave={barcode:barcode,saveStatus:'NF_DUPLICATE',details:data.details||data.message||'Not found duplicate',origin:'NF'};
        showSaveButton('save-dp','Save');
      }
    })
    .catch(function(e){
      document.getElementById('loading').style.display='none';
      showResult({status:'error',barcode:barcode,message:'Connection error.'});
      isChecking=false;
      document.getElementById('tapOverlay').style.display='flex';
    });
}

// SHOW RESULT
function showResult(r){
  var c=document.getElementById('resultCard');
  var icon=document.getElementById('rIcon');
  var stat=document.getElementBy
